<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–‡ä»¶ç®¡ç†åå°</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { background:#f3f4f6; }
  .card { @apply bg-white rounded-2xl shadow p-6 mb-8; }
  .tag {
    @apply inline-block bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded mr-1 cursor-pointer;
  }
  .btn { @apply px-4 py-2 rounded-lg text-white font-medium; }
  .btn-primary { @apply bg-blue-600 hover:bg-blue-700; }
  .btn-danger { @apply bg-red-600 hover:bg-red-700; }
</style>

</head>

<body class="p-4">

<h1 class="text-2xl font-bold mb-6 flex items-center">ğŸ“ æ–‡ä»¶ç®¡ç†åå°</h1>

<!-- å…¨å±€æç¤º -->
<div id="toast" class="hidden p-4 rounded-lg mb-4 text-white"></div>

<!-- ä¸Šä¼ åŒºåŸŸ -->
<div class="card">
  <h2 class="text-xl font-semibold mb-4">ä¸Šä¼ æ–‡ä»¶</h2>

  <div class="mb-3">
    <input id="fileInput" type="file" multiple class="w-full p-3 rounded-lg bg-gray-100">
  </div>

  <div class="mb-3">
    <input id="tagInput" type="text" placeholder="æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œå¤šæ ‡ç­¾ç”¨ç©ºæ ¼åˆ†éš”ï¼‰"
           class="w-full p-3 rounded-lg bg-gray-100">
  </div>

  <button id="uploadBtn" class="btn btn-primary w-full">å¼€å§‹ä¸Šä¼ </button>
</div>

<!-- æœç´¢æ¡† -->
<div class="card">
  <h2 class="text-xl font-semibold mb-4">æœç´¢</h2>

  <input id="searchInput" type="text" placeholder="æœç´¢æ ‡ç­¾æˆ–æ–‡ä»¶å"
         class="w-full p-3 rounded-lg bg-gray-100 mb-3">

  <button id="searchBtn" class="btn btn-primary w-full">æœç´¢</button>
</div>

<!-- æ–‡ä»¶åˆ—è¡¨ -->
<div class="card">
  <h2 class="text-xl font-semibold mb-4">æ–‡ä»¶åˆ—è¡¨</h2>
  <div id="fileList" class="space-y-4"></div>
</div>

<script>
function toast(msg, type="success") {
  const box = document.getElementById("toast");
  box.classList.remove("hidden");
  box.textContent = msg;
  box.style.background = type === "success" ? "#16a34a" : "#dc2626";
  setTimeout(() => box.classList.add("hidden"), 3000);
}

// ä¸Šä¼ æ–‡ä»¶
document.getElementById("uploadBtn").onclick = async () => {
  const files = document.getElementById("fileInput").files;
  if (!files.length) return toast("è¯·å…ˆé€‰æ‹©æ–‡ä»¶", "error");

  const tags = document.getElementById("tagInput").value.trim();

  for (const f of files) {
    const form = new FormData();
    form.append("file", f);

    // è°ƒç”¨ /upload ä¸Šä¼ æ–‡ä»¶åˆ° Telegram
    const uploadRes = await fetch("/upload", { method: "POST", body: form });
    const uploadJson = await uploadRes.json();

    if (!uploadJson.ok) {
      toast("ä¸Šä¼ å¤±è´¥ï¼š" + (uploadJson.error || "æœªçŸ¥é”™è¯¯"), "error");
      continue;
    }

    // ä¿å­˜è®°å½•åˆ° KVï¼š/manage/save
    await fetch("/manage/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        file_id: uploadJson.file_id,
        file_name: f.name,
        tags,
        url: uploadJson.url
      })
    });

    toast("ä¸Šä¼ æˆåŠŸï¼š" + f.name, "success");
  }

  loadFiles();
};

// æœç´¢æŒ‰é’®
document.getElementById("searchBtn").onclick = () => {
  loadFiles(document.getElementById("searchInput").value.trim());
};

// åŠ è½½æ–‡ä»¶åˆ—è¡¨
async function loadFiles(keyword = "") {
  const res = await fetch("/manage/list");
  const data = await res.json();

  if (!data.ok) {
    document.getElementById("fileList").innerHTML =
      "<p class='text-gray-600'>åŠ è½½å¤±è´¥ï¼š" + (data.error || "") + "</p>";
    return;
  }

  const list = data.files || [];
  const box = document.getElementById("fileList");
  box.innerHTML = "";

  const filtered = list.filter(item => {
    if (!keyword) return true;
    return (
      item.name.includes(keyword) ||
      (item.tags && item.tags.includes(keyword))
    );
  });

  filtered.forEach(item => {
    const div = document.createElement("div");
    div.className = "p-4 bg-gray-100 rounded-xl";

    const tagHTML = (item.tags || "")
      .split(" ")
      .filter(t => t.trim().length)
      .map(t => `<span class="tag">${t}</span>`)
      .join("");

    div.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <p class="font-bold">${item.name}</p>
          <p class="text-gray-500 text-xs">${item.url}</p>
        </div>
        <a href="${item.url}" target="_blank"
           class="btn btn-primary text-xs">æ‰“å¼€</a>
      </div>
      <div class="mt-2">${tagHTML}</div>
    `;

    box.appendChild(div);
  });

  if (filtered.length === 0) {
    box.innerHTML = "<p class='text-gray-500'>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–‡ä»¶</p>";
  }
}

// åˆå§‹åŒ–
loadFiles();
</script>

</body>
</html>
