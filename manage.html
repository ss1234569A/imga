<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–‡ä»¶ç®¡ç†åå°</title>

<!-- ç°ä»£å¡ç‰‡ UIï¼šTailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { background:#f6f7fb; }
  .card {
    @apply bg-white rounded-2xl shadow p-6 mb-8;
  }
  .btn {
    @apply px-4 py-2 rounded-lg text-white font-medium;
  }
  .btn-primary { @apply bg-blue-600 hover:bg-blue-700; }
  .btn-danger { @apply bg-red-600 hover:bg-red-700; }
  .tag {
    @apply inline-block bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded mr-1 cursor-pointer;
  }
</style>
</head>

<body class="p-4">

<h1 class="text-2xl font-bold mb-6 flex items-center">
  ğŸ“ æ–‡ä»¶ç®¡ç†åå°
</h1>

<!-- å…¨å±€æç¤º -->
<div id="toast" class="hidden p-4 rounded-lg mb-4"></div>

<!-- ä¸Šä¼ åŒºåŸŸ -->
<div class="card">
  <h2 class="text-xl font-semibold mb-4">ä¸Šä¼ æ–‡ä»¶</h2>

  <div class="mb-3">
    <input id="fileInput" type="file" class="w-full bg-gray-100 p-3 rounded-lg" multiple>
  </div>

  <div class="mb-3">
    <input id="tagInput" type="text" placeholder="ä¸ºæ–‡ä»¶æ·»åŠ æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œå¤šä¸ªç”¨ç©ºæ ¼åˆ†éš”ï¼‰"
           class="w-full bg-gray-100 p-3 rounded-lg">
  </div>

  <button id="uploadBtn" class="btn btn-primary w-full">å¼€å§‹ä¸Šä¼ </button>
</div>

<!-- æœç´¢ -->
<div class="card">
  <h2 class="text-xl font-semibold mb-4">æœç´¢æ–‡ä»¶</h2>
  <input id="searchInput" type="text" placeholder="è¾“å…¥å…³é”®è¯ï¼ˆæ–‡ä»¶åæˆ–æ ‡ç­¾ï¼‰"
         class="w-full bg-gray-100 p-3 rounded-lg mb-3">
  <button id="searchBtn" class="btn btn-primary w-full">æœç´¢</button>
</div>

<!-- æ–‡ä»¶åˆ—è¡¨ -->
<div class="card">
  <h2 class="text-xl font-semibold mb-4">æ–‡ä»¶åˆ—è¡¨</h2>
  <div id="fileList" class="space-y-4"></div>
</div>

<script>
const toast = (msg, type="success") => {
  const box = document.getElementById("toast");
  box.className = `p-4 rounded-lg mb-4 text-white ${type==="success" ? "bg-green-600" : "bg-red-600"}`;
  box.innerText = msg;
  box.classList.remove("hidden");
  setTimeout(() => box.classList.add("hidden"), 3000);
};

// ä¸Šä¼ æ–‡ä»¶
document.getElementById("uploadBtn").onclick = async () => {
  const files = document.getElementById("fileInput").files;
  if (!files.length) return toast("è¯·å…ˆé€‰æ‹©æ–‡ä»¶", "error");

  const tags = document.getElementById("tagInput").value.trim();

  for (let f of files) {
    const form = new FormData();
    form.append("file", f);

    const res = await fetch("/upload", { method:"POST", body: form });
    const json = await res.json();

    if (!json.ok) {
      toast("ä¸Šä¼ å¤±è´¥ï¼š" + (json.error || "æœªçŸ¥é”™è¯¯"), "error");
      continue;
    }

    // ä¿å­˜åˆ° KV
    await fetch("/manage/save", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        id: json.file_id,
        name: f.name,
        url: json.url,
        tags
      })
    });

    toast("ä¸Šä¼ æˆåŠŸï¼š" + f.name);
  }

  loadFiles();
};

// æœç´¢
document.getElementById("searchBtn").onclick = () => {
  loadFiles(document.getElementById("searchInput").value.trim());
};

// åŠ è½½æ–‡ä»¶
async function loadFiles(keyword = "") {
  const res = await fetch("/manage/list");
  const all = await res.json();

  const box = document.getElementById("fileList");
  box.innerHTML = "";

  const list = all.filter(item => {
    if (!keyword) return true;
    return item.name.includes(keyword) || (item.tags && item.tags.includes(keyword));
  });

  list.forEach(item => {
    const div = document.createElement("div");
    div.className = "p-4 bg-gray-100 rounded-xl";

    const tagHTML = (item.tags || "")
      .split(" ")
      .filter(t => t.trim().length)
      .map(t => `<span class="tag">${t}</span>`)
      .join("");

    div.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <p class="font-semibold">${item.name}</p>
          <p class="text-gray-600 text-sm">${item.url}</p>
        </div>
        <a href="${item.url}" target="_blank" class="btn btn-primary text-xs">æ‰“å¼€</a>
      </div>
      <div class="mt-2">${tagHTML}</div>
    `;
    box.appendChild(div);
  });
}

loadFiles(); // åˆå§‹åŒ–
</script>

</body>
  </html>
