<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ–‡ä»¶ç®¡ç†åå° - Telegraph å›¾åºŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --card-soft: #0b1220;
      --accent: #4f46e5;
      --accent-soft: rgba(79,70,229,0.18);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
      --chip-bg: #111827;
      --chip-active: #4f46e5;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
      color: var(--text);
      padding: 18px;
    }
    @media (min-width: 960px) {
      body { padding: 24px 32px; }
    }
    .layout {
      max-width: 1120px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.5fr);
      gap: 18px;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: minmax(0, 1fr); }
    }
    .header-title {
      max-width: 1120px;
      margin: 0 auto 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-icon {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 0, #facc15, #f97316);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111827;
      font-size: 20px;
    }
    h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: .02em;
    }
    .subtitle {
      margin: 0;
      font-size: .8rem;
      color: var(--text-soft);
    }

    .card {
      background: linear-gradient(135deg, #020617, #020617) padding-box,
                  linear-gradient(135deg, rgba(96,165,250,.35), rgba(129,140,248,.5)) border-box;
      border-radius: 18px;
      border: 1px solid transparent;
      padding: 16px 16px 12px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
    }
    .card-inner {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: 13px;
      padding: 12px 12px 10px;
      border: 1px solid rgba(55,65,81,0.7);
    }
    h2 {
      margin: 0 0 6px;
      font-size: 1rem;
    }

    label {
      font-size: .8rem;
      color: var(--text-soft);
      display: block;
      margin-bottom: 6px;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      font-size: .85rem;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      outline: none;
    }
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79,70,229,0.55);
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: .86rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      background: var(--accent);
      color: white;
      box-shadow: 0 12px 30px rgba(79,70,229,.45);
      transition: transform .08s ease, box-shadow .08s ease, background .08s;
      white-space: nowrap;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(79,70,229,.6);
    }
    button:disabled {
      opacity: .55;
      box-shadow: none;
      transform: none;
      cursor: default;
    }
    .btn-light {
      background: transparent;
      color: var(--text-soft);
      box-shadow: none;
      border-radius: 10px;
      padding-inline: 12px;
    }
    .btn-light:hover {
      background: rgba(148,163,184,0.12);
      box-shadow: none;
      transform: none;
    }

    .stack { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .row > * { flex: 1; }

    .log {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 11px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(55,65,81,0.8);
      font-size: .78rem;
      max-height: 130px;
      overflow: auto;
      white-space: pre-wrap;
      color: var(--text-soft);
    }
    .log-title {
      font-weight: 600;
      color: #c7d2fe;
      margin-bottom: 2px;
    }

    .files-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 6px;
    }
    .pill {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: .78rem;
      border: 1px solid rgba(75,85,99,0.8);
      background: rgba(15,23,42,0.9);
      color: var(--text-soft);
    }

    .search-bar {
      margin-top: 4px;
    }

    .chips {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      max-height: 90px;
      overflow: auto;
    }
    .chip {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: .75rem;
      background: var(--chip-bg);
      color: var(--text-soft);
      border: 1px solid rgba(55,65,81,0.9);
      cursor: pointer;
      user-select: none;
    }
    .chip span {
      margin-left: 4px;
      opacity: .75;
      font-size: .7rem;
    }
    .chip.active {
      background: var(--chip-active);
      color: #e5e7ff;
      border-color: transparent;
    }

    .files-box {
      margin-top: 8px;
      border-radius: 13px;
      border: 1px solid rgba(31,41,55,0.9);
      background: radial-gradient(circle at top, #020617, #020617);
      max-height: 420px;
      overflow: auto;
    }
    .file-row {
      display: grid;
      grid-template-columns: minmax(0, 4fr) minmax(0, 2fr) minmax(0, 2.2fr) auto;
      gap: 8px;
      padding: 8px 10px;
      font-size: .8rem;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      align-items: center;
    }
    .file-row:last-child { border-bottom: none; }

    .file-name {
      font-weight: 500;
      color: #e5e7eb;
      word-break: break-all;
    }
    .file-meta {
      color: var(--text-soft);
      font-size: .74rem;
    }
    .file-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .tag-pill {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: .72rem;
      background: rgba(30,64,175,0.25);
      color: #c7d2fe;
    }
    .file-actions a {
      font-size: .74rem;
      text-decoration: none;
      color: #93c5fd;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.96);
    }
    .file-actions a:hover {
      background: rgba(37,99,235,0.35);
      border-color: rgba(96,165,250,0.9);
    }
    .empty {
      padding: 20px;
      text-align: center;
      font-size: .8rem;
      color: var(--text-soft);
    }

    @media (max-width: 720px) {
      .file-row {
        grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.2fr);
        grid-template-rows: auto auto;
        grid-template-areas:
          "name actions"
          "meta tags";
      }
      .file-row > div:nth-child(1) { grid-area: name; }
      .file-row > div:nth-child(2) { grid-area: meta; }
      .file-row > div:nth-child(3) { grid-area: tags; }
      .file-row > div:nth-child(4) { grid-area: actions; justify-self: end; }
    }
  </style>
</head>
<body>

<div class="header-title">
  <div class="header-icon">ğŸ“</div>
  <div>
    <h1>æ–‡ä»¶ç®¡ç†åå°</h1>
    <p class="subtitle">Telegraph é¢‘é“å­˜å‚¨ Â· ä»»æ„æ–‡ä»¶ Â· æ ‡ç­¾ç³»ç»Ÿ Â· æ‰¹é‡ä¸Šä¼ </p>
  </div>
</div>

<div class="layout">

  <!-- å·¦ä¾§ï¼šä¸Šä¼ åŒº -->
  <div class="card">
    <div class="card-inner">
      <h2>ä¸Šä¼ æ–‡ä»¶</h2>
      <p class="subtitle" style="margin-bottom:6px;">
        æ”¯æŒä»»æ„ç±»å‹ï¼Œæ‰¹é‡ä¸Šä¼ ã€‚é€‰æ‹©æ–‡ä»¶åï¼Œä¸ä¼šè‡ªåŠ¨ä¸Šä¼ ï¼Œéœ€ç‚¹å‡»â€œå¼€å§‹ä¸Šä¼ â€ã€‚
      </p>

      <div class="stack">
        <div class="row">
          <button id="chooseBtn" type="button">é€‰æ‹©æ–‡ä»¶</button>
          <button id="uploadBtn" type="button">å¼€å§‹ä¸Šä¼ </button>
        </div>

        <input id="fileInput" type="file" name="file" multiple style="display:none;" />

        <div>
          <label>å½“å‰å·²é€‰æ‹©æ–‡ä»¶</label>
          <div id="chosenFiles" class="file-meta">æœªé€‰æ‹©æ–‡ä»¶</div>
        </div>

        <div>
          <label>æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œé€—å·åˆ†éš”ï¼šå¦‚ â€œè‹±è¯­, è§†é¢‘, ç”Ÿè¯æœ¬â€ï¼‰</label>
          <input id="tagsInput" type="text" placeholder="ç¤ºä¾‹ï¼šè‹±è¯­, è§†é¢‘, ç”Ÿè¯æœ¬" />
        </div>

        <div class="log">
          <div class="log-title">ä¸Šä¼ æ—¥å¿—</div>
          <div id="logBody">ç­‰å¾…ä¸Šä¼ æ“ä½œâ€¦</div>
        </div>
      </div>
    </div>
  </div>

  <!-- å³ä¾§ï¼šæ–‡ä»¶åˆ—è¡¨ -->
  <div class="card">
    <div class="card-inner">
      <div class="files-header">
        <div>
          <h2>æ–‡ä»¶åˆ—è¡¨</h2>
          <p class="subtitle">å¯æŒ‰åç§°/æ ‡ç­¾æœç´¢ï¼Œå¹¶æŒ‰æ ‡ç­¾ç­›é€‰</p>
        </div>
        <div class="pill"><span id="countLabel">0</span> ä¸ªæ–‡ä»¶</div>
      </div>

      <div class="search-bar">
        <input id="searchInput" type="text" placeholder="æœç´¢æ–‡ä»¶åæˆ–æ ‡ç­¾â€¦" />
      </div>

      <div class="chips" id="tagChips"></div>

      <div class="files-box" id="fileList">
        <div class="empty">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨â€¦</div>
      </div>

      <div style="margin-top:8px;display:flex;justify-content:flex-end;">
        <button class="btn-light" id="refreshBtn" type="button">åˆ·æ–°åˆ—è¡¨</button>
      </div>
    </div>
  </div>

</div>

<script>
  const chooseBtn   = document.getElementById("chooseBtn");
  const uploadBtn   = document.getElementById("uploadBtn");
  const fileInput   = document.getElementById("fileInput");
  const chosenFiles = document.getElementById("chosenFiles");
  const tagsInput   = document.getElementById("tagsInput");
  const logBody     = document.getElementById("logBody");
  const fileListEl  = document.getElementById("fileList");
  const searchInput = document.getElementById("searchInput");
  const tagChips    = document.getElementById("tagChips");
  const countLabel  = document.getElementById("countLabel");
  const refreshBtn  = document.getElementById("refreshBtn");

  let allFiles = [];
  let activeTag = "";

  function log(msg, reset = false) {
    if (reset) logBody.textContent = msg;
    else logBody.textContent += "\\n" + msg;
    logBody.scrollTop = logBody.scrollHeight;
  }

  function humanSize(bytes) {
    if (!bytes && bytes !== 0) return "-";
    const units = ["B", "KB", "MB", "GB", "TB"];
    let i = 0;
    let value = bytes;
    while (value >= 1024 && i < units.length - 1) {
      value /= 1024;
      i++;
    }
    return value.toFixed(1) + " " + units[i];
  }

  function formatTime(ts) {
    if (!ts) return "";
    const d = new Date(ts);
    return d.toLocaleString();
  }

  function updateChosenLabel() {
    const files = fileInput.files;
    if (!files.length) {
      chosenFiles.textContent = "æœªé€‰æ‹©æ–‡ä»¶";
      return;
    }
    if (files.length === 1) {
      chosenFiles.textContent = files[0].name;
    } else {
      chosenFiles.textContent = files.length + " ä¸ªæ–‡ä»¶å·²é€‰æ‹©";
    }
  }

  chooseBtn.onclick = () => {
    fileInput.click();
  };

  fileInput.onchange = () => {
    updateChosenLabel();
    log("å·²é€‰æ‹© " + fileInput.files.length + " ä¸ªæ–‡ä»¶ï¼ˆå°šæœªä¸Šä¼ ï¼‰", true);
  };

  uploadBtn.onclick = async () => {
    const files = fileInput.files;
    if (!files.length) {
      log("è¯·å…ˆé€‰æ‹©æ–‡ä»¶ã€‚", true);
      return;
    }

    uploadBtn.disabled = true;
    chooseBtn.disabled = true;

    const tags = tagsInput.value.trim();
    const form = new FormData();

    for (const f of files) {
      form.append("file", f);
    }
    if (tags) form.append("tags", tags);

    log("å¼€å§‹ä¸Šä¼ ï¼Œå…± " + files.length + " ä¸ªæ–‡ä»¶â€¦", true);

    try {
      const resp = await fetch("/upload", { method: "POST", body: form });
      const data = await resp.json();

      log("æœåŠ¡å™¨è¿”å›çŠ¶æ€ï¼š" + resp.status);

      if (!resp.ok || !data.ok) {
        log("ä¸Šä¼ å¤±è´¥ï¼š" + JSON.stringify(data));
      } else {
        log("ä¸Šä¼ æˆåŠŸï¼š\\n" + JSON.stringify(data.files, null, 2));
        // æ¸…ç©ºé€‰æ‹©
        fileInput.value = "";
        updateChosenLabel();
        tagsInput.value = "";
        await loadFiles();
      }
    } catch (err) {
      log("ä¸Šä¼ å¼‚å¸¸ï¼š" + err);
    } finally {
      uploadBtn.disabled = false;
      chooseBtn.disabled = false;
    }
  };

  refreshBtn.onclick = () => {
    loadFiles();
  };

  function renderList() {
    const q = searchInput.value.trim().toLowerCase();
    const tagFilter = activeTag.toLowerCase();

    let files = allFiles.slice();

    if (q) {
      files = files.filter((f) => {
        const name = (f.name || "").toLowerCase();
        const tagStr = (f.tags || []).join(" ").toLowerCase();
        return name.includes(q) || tagStr.includes(q);
      });
    }

    if (tagFilter) {
      files = files.filter((f) =>
        (f.tags || []).map(t => t.toLowerCase()).includes(tagFilter)
      );
    }

    countLabel.textContent = allFiles.length;

    if (!files.length) {
      fileListEl.innerHTML = '<div class="empty">æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚</div>';
      return;
    }

    fileListEl.innerHTML = files.map(f => {
      const tagsHtml = (f.tags || [])
        .map(t => `<span class="tag-pill">${t}</span>`)
        .join("");
      return `
        <div class="file-row">
          <div>
            <div class="file-name">${f.name || "(æœªå‘½åæ–‡ä»¶)"}</div>
            <div class="file-meta">${formatTime(f.time)}</div>
          </div>
          <div class="file-meta">${humanSize(f.size)}</div>
          <div class="file-tags">
            ${tagsHtml || '<span class="file-meta" style="opacity:.6;">æ— æ ‡ç­¾</span>'}
          </div>
          <div class="file-actions">
            <a href="${f.url}" target="_blank">æ‰“å¼€/ä¸‹è½½</a>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderTags() {
    const tagCount = {};
    allFiles.forEach(f => {
      (f.tags || []).forEach(t => {
        if (!t) return;
        tagCount[t] = (tagCount[t] || 0) + 1;
      });
    });

    const tags = Object.keys(tagCount).sort((a, b) => tagCount[b] - tagCount[a]);

    tagChips.innerHTML =
      `<div class="chip ${activeTag === "" ? "active" : ""}" data-tag="">å…¨éƒ¨<span>${allFiles.length}</span></div>` +
      tags.map(t =>
        `<div class="chip ${activeTag === t ? "active" : ""}" data-tag="${t}">
           ${t}<span>${tagCount[t]}</span>
         </div>`
      ).join("");

    tagChips.querySelectorAll(".chip").forEach(chip => {
      chip.onclick = () => {
        activeTag = chip.dataset.tag || "";
        tagChips.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        renderList();
      };
    });
  }

  async function loadFiles() {
    fileListEl.innerHTML = '<div class="empty">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨â€¦</div>';
    try {
      const resp = await fetch("/manage/list");
      const data = await resp.json();

      if (!resp.ok || !data.ok) {
        fileListEl.innerHTML = '<div class="empty">åŠ è½½å¤±è´¥ï¼š' + (data.error || resp.status) + '</div>';
        return;
      }

      allFiles = data.items || data.files || [];
      renderTags();
      renderList();
    } catch (err) {
      fileListEl.innerHTML = '<div class="empty">åŠ è½½å¤±è´¥ï¼š' + err + '</div>';
    }
  }

  searchInput.addEventListener("input", renderList);

  // åˆå§‹åŒ–
  updateChosenLabel();
  loadFiles();
</script>

</body>
</html>
