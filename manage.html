<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>文件管理中心 - Telegraph 图床</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #4f46e5;
      --accent-soft: rgba(79,70,229,0.12);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --border: #1f2937;
      --chip-bg: #1f2937;
      --chip-active: #4f46e5;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d2436 0, #020617 60%);
      color: var(--text);
      padding: 24px;
    }
    .layout {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr);
      gap: 20px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      background: linear-gradient(135deg, #020617, #020617) padding-box,
                  linear-gradient(135deg, rgba(96,165,250,.3), rgba(129,140,248,.6)) border-box;
      border-radius: 18px;
      border: 1px solid transparent;
      padding: 18px 18px 14px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
    }
    h1 {
      margin: 0 0 6px;
      font-size: 1.5rem;
      letter-spacing: .02em;
    }
    .subtitle {
      margin: 0;
      font-size: .85rem;
      color: var(--text-soft);
    }
    label {
      font-size: .8rem;
      color: var(--text-soft);
      display: block;
      margin-bottom: 6px;
    }
    input[type="file"],
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-size: .9rem;
      outline: none;
    }
    input[type="file"] {
      padding: 7px 10px;
    }
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79,70,229,0.5);
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: .86rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      background: var(--accent);
      color: white;
      box-shadow: 0 10px 30px rgba(79,70,229,.4);
      transition: transform .1s ease, box-shadow .1s ease, background .1s;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 15px 40px rgba(79,70,229,.55);
    }
    button:disabled {
      opacity: .5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .btn-secondary {
      background: transparent;
      color: var(--text-soft);
      box-shadow: none;
      border-radius: 10px;
      padding-inline: 12px;
    }
    .btn-secondary:hover {
      background: rgba(148,163,184,0.1);
      box-shadow: none;
      transform: none;
    }
    .upload-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .badge {
      font-size: .75rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: #c7d2fe;
    }
    .stack {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .row {
      display: flex;
      gap: 10px;
    }
    .row > div {
      flex: 1;
    }
    .log {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.6);
      font-size: .78rem;
      max-height: 140px;
      overflow: auto;
      white-space: pre-wrap;
    }
    .log-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #cbd5f5;
    }
    .log-body {
      color: var(--text-soft);
      line-height: 1.4;
    }
    .search-bar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
      max-height: 80px;
      overflow: auto;
    }
    .chip {
      padding: 3px 10px;
      border-radius: 999px;
      background: var(--chip-bg);
      font-size: .75rem;
      color: var(--text-soft);
      cursor: pointer;
      border: 1px solid transparent;
    }
    .chip.active {
      background: var(--chip-active);
      color: #e5e7ff;
    }
    .chip span {
      opacity: .8;
      margin-left: 4px;
      font-size: .7rem;
    }
    .files {
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.85);
      max-height: 420px;
      overflow: auto;
    }
    .file-row {
      display: grid;
      grid-template-columns: minmax(0, 4fr) minmax(0, 2fr) minmax(0, 2fr) auto;
      gap: 8px;
      padding: 8px 12px;
      align-items: center;
      font-size: .82rem;
      border-bottom: 1px solid rgba(31,41,55,0.7);
    }
    .file-row:last-child {
      border-bottom: none;
    }
    .file-name {
      font-weight: 500;
      color: #e5e7eb;
      word-break: break-all;
    }
    .file-meta {
      color: var(--text-soft);
      font-size: .76rem;
    }
    .file-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: .74rem;
    }
    .file-tags span {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(31,41,55,0.9);
      color: #9ca3ff;
    }
    .file-actions a {
      font-size: .78rem;
      text-decoration: none;
      color: #93c5fd;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.8);
    }
    .file-actions a:hover {
      background: rgba(30,64,175,0.4);
      border-color: rgba(96,165,250,0.9);
    }
    .empty {
      padding: 18px;
      text-align: center;
      font-size: .8rem;
      color: var(--text-soft);
    }
    .pill {
      font-size: .78rem;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(75,85,99,0.7);
      color: var(--text-soft);
    }
  </style>
</head>
<body>

<div class="layout">
  <!-- 左：上传 -->
  <div class="card">
    <div class="upload-header">
      <div>
        <h1>Telegraph 文件图床 · 控制台</h1>
        <p class="subtitle">支持任意文件类型 · 批量上传 · 标签系统</p>
      </div>
      <div class="badge">实时保存</div>
    </div>

    <div class="stack">
      <div>
        <label>选择文件（支持多选）</label>
        <input id="fileInput" type="file" multiple />
      </div>

      <div>
        <label>标签（用逗号分隔：例如 英语, 视频）</label>
        <input id="tagsInput" type="text" placeholder="例如：英语, 视频, 生词本" />
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <button id="uploadBtn">上传文件</button>
        <button class="btn-secondary" id="refreshBtn">刷新列表</button>
      </div>

      <div class="log">
        <div class="log-title">上传日志</div>
        <div class="log-body" id="logBody">等待上传…</div>
      </div>
    </div>
  </div>

  <!-- 右：列表 -->
  <div class="card">
    <div class="upload-header">
      <div>
        <h2 style="margin:0;font-size:1.1rem;">文件库</h2>
        <p class="subtitle">搜索、标签过滤、所有文件记录</p>
      </div>
      <div class="pill"><span id="countLabel">0</span> 个文件</div>
    </div>

    <div class="search-bar">
      <input id="searchInput" type="text" placeholder="搜索文件名或标签…" />
    </div>

    <div class="chips" id="tagChips"></div>

    <div class="files" id="fileList">
      <div class="empty">正在加载文件列表…</div>
    </div>
  </div>
</div>

<script>
  const fileInput = document.getElementById("fileInput");
  const tagsInput = document.getElementById("tagsInput");
  const uploadBtn = document.getElementById("uploadBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const logBody = document.getElementById("logBody");
  const fileListEl = document.getElementById("fileList");
  const searchInput = document.getElementById("searchInput");
  const tagChips = document.getElementById("tagChips");
  const countLabel = document.getElementById("countLabel");

  let allFiles = [];
  let activeTag = "";

  function log(msg, reset = false) {
    if (reset) logBody.textContent = msg;
    else logBody.textContent += "\\n" + msg;
    logBody.scrollTop = logBody.scrollHeight;
  }

  function humanSize(bytes) {
    if (!bytes) return "-";
    const units = ["B", "KB", "MB", "GB"];
    let i = 0;
    let num = bytes;
    while (num >= 1024 && i < units.length - 1) {
      num /= 1024;
      i++;
    }
    return num.toFixed(1) + " " + units[i];
  }

  function formatTime(ts) {
    if (!ts) return "";
    const d = new Date(ts);
    return d.toLocaleString();
  }

  function renderList() {
    const q = searchInput.value.trim().toLowerCase();
    const tag = activeTag.toLowerCase();

    let files = allFiles.slice();

    if (q) {
      files = files.filter((f) => {
        const name = (f.name || "").toLowerCase();
        const tagStr = (f.tags || []).join(" ").toLowerCase();
        return name.includes(q) || tagStr.includes(q);
      });
    }

    if (tag) {
      files = files.filter((f) =>
        (f.tags || []).map((t) => t.toLowerCase()).includes(tag)
      );
    }

    countLabel.textContent = allFiles.length;

    if (!files.length) {
      fileListEl.innerHTML =
        '<div class="empty">没有匹配的文件。</div>';
      return;
    }

    fileListEl.innerHTML = files
      .map((f) => {
        const tagsHtml = (f.tags || [])
          .map((t) => `<span>${t}</span>`)
          .join("");
        return `
        <div class="file-row">
          <div>
            <div class="file-name">${f.name || "(未命名文件)"}</div>
            <div class="file-meta">${formatTime(f.time)}</div>
          </div>
          <div class="file-meta">${humanSize(f.size)}</div>
          <div class="file-tags">${tagsHtml || '<span style="opacity:.6;">无</span>'}</div>
          <div class="file-actions">
            <a href="${f.url}" target="_blank">下载</a>
          </div>
        </div>
      `;
      })
      .join("");
  }

  function renderTags() {
    const tagCount = {};
    allFiles.forEach((f) => {
      (f.tags || []).forEach((t) => {
        if (!t) return;
        tagCount[t] = (tagCount[t] || 0) + 1;
      });
    });

    const tags = Object.keys(tagCount).sort((a, b) => tagCount[b] - tagCount[a]);

    tagChips.innerHTML =
      `<span class="chip ${activeTag === "" ? "active" : ""}" data-tag="">全部</span>` +
      tags
        .map(
          (t) =>
            `<span class="chip ${
              activeTag === t ? "active" : ""
            }" data-tag="${t}">${t}<span>${tagCount[t]}</span></span>`
        )
        .join("");

    tagChips.querySelectorAll(".chip").forEach((chip) => {
      chip.onclick = () => {
        activeTag = chip.dataset.tag || "";
        tagChips
          .querySelectorAll(".chip")
          .forEach((c) => c.classList.remove("active"));
        chip.classList.add("active");
        renderList();
      };
    });
  }

  async function loadFiles() {
    fileListEl.innerHTML = '<div class="empty">加载中…</div>';

    try {
      const res = await fetch("/manage/list");
      const data = await res.json();

      if (!data.ok) {
        fileListEl.innerHTML =
          '<div class="empty">加载失败：' + data.error + "</div>";
        return;
      }

      allFiles = data.items || [];
      renderTags();
      renderList();
    } catch (e) {
      fileListEl.innerHTML = '<div class="empty">加载失败：' + e + "</div>";
    }
  }

  uploadBtn.onclick = async () => {
    const files = fileInput.files;
    if (!files.length) {
      log("请先选择文件。", true);
      return;
    }

    uploadBtn.disabled = true;
    log("开始上传…", true);

    const form = new FormData();
    [...files].forEach((f) => form.append("file", f));

    const tags = tagsInput.value.trim();
    if (tags) form.append("tags", tags);

    try {
      const res = await fetch("/upload", { method: "POST", body: form });
      log("服务器返回：" + res.status);

      const data = await res.json
